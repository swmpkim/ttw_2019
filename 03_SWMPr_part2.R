library(SWMPr)
library(lubridate)

### so far we have used SWMPr for:
# importing multiple data files from a station with import_local()
# selecting which values to keep based on QAQC flags and codes with qaqc()


## SWMPr can do some other things too



## first, a bit of cleanup ----
## get rid of these columns that are full of NAs
## (because they're parameters that aren't reported)
# as with everything else in R, there are multiple ways to do this

# one way: turn a column into "NULL":
bhwq_qaqc$level <- NULL
head(bhwq_qaqc)

# there are other functions for subsetting
# especially 'select' from dplyr
# but we want these to stay as 'swmpr' objects
# and SWMPr has a subset function too:
?subset.swmpr

bhwq_qaqc <- subset(bhwq_qaqc, rem_cols = TRUE)
bhwq_qaqc2 <- subset(bhwq_qaqc2, rem_cols = TRUE)
bhwq_qaqc3 <- subset(bhwq_qaqc2, rem_cols = TRUE)





## aggregate data by a specified time period ----

# what if we want monthly averages?
avgs <- aggreswmp(bhwq_qaqc, by = "months")
head(avgs)



# the default argument for aggreswmp is mean, with na.rm = TRUE
# notice it looks like each month is represented by the first day of it
# that's because R doesn't handle year-month alone very well

# what if we want min?
mins <- aggreswmp(bhwq_qaqc, by = "months", FUN = min)
head(mins)


## remember na.rm = TRUE? Here, we just add it with a comma
mins2 <- aggreswmp(bhwq_qaqc, by = "months", FUN = min, na.rm = TRUE)
head(mins2)



## you can also select one (or more) parameters:
mins3 <- aggreswmp(bhwq_qaqc, by = "months", params = c("temp", "sal"),
                   FUN = min, na.rm = TRUE)
head(mins3)



## know when this is really helpful?
## using the sum() function to calculate daily rainfall

# import met data (Grand Bay's is gndcrmet; 
# you can use your own data if you'd like)

# what function do we use???
met_data <- -------(data_path, "gndcrmet", trace = TRUE)


# run the qaqc step
met_qc <- qaqc(met_data, qaqc_keep = c(0, 1, 4, 5))

# remind ourselves what the names look like
names(met_qc)  

# use aggreswmp() to get daily rain totals
# put it into an object called "daily_rain"
daily_rain <- aggreswmp(met_qc, by = "days", params = "totprcp",
                        FUN = sum)
head(daily_rain)


#### how would we find maximum daily rainfall over this time period?
-----(---$---)


# how do we find the date on which that happened?
## subsetting ----

# remember the square brackets that helped us
# select parts of a vector?
# we can use those to subset data frames too
# [rows, columns]   or  [x, y]
met_qc[1, ]   # selects the first row; all columns
met_qc[ , 1]  # selects all rows; first column

# note: the above line gives the same results as:
met_qc$datetimestamp
# but we don't have to know the name of the column
# each method of column selection is useful; which to use 
# depends on the situation



# what will this give us?
met_qc[1, 1]

# another way to get that is:
met_qc$datetimestamp[1]    
# because we've specified the column with the $,
# we only have to account for rows inside the square brackets


# to specify multiple rows or columns,
# make a sequence using a :
met_qc[1:6, ]

# does that output look familiar?


## back to the problem of finding which date had the maximum daily rainfall

# first, we can calculate the max
max(daily_rain$totprcp, na.rm = TRUE)

# a function called which.max() can tell us which row that occurs on:
which.max(daily_rain$totprcp)


# so we need to use the row number generated by which.max()
# to subset the data frame:

# daily_rain[ conditon-here , ]   

daily_rain[which.max(daily_rain$totprcp), ]


# or, to make the steps seem simpler,
# we can assign the row of the max to its own object
row_index <- which.max(daily_rain$totprcp)

row_index


daily_rain[row_index, ]




# if all we really want is the date, and we don't care about the total,
# we can subset this way:
daily_rain[row_index, 1]

# or
daily_rain[row_index, "datetimestamp"]

# or
daily_rain$datetimestamp[row_index]  ## no comma here

# notice these are simplifying from a data frame to a vector of 1
# if we want to keep the data frame structure, 
# we have to include drop = FALSE:
daily_rain[row_index, 1, drop = FALSE]


### you do NOT have to memorize all these different ways to subset
# but you should be aware that they exist

# the dplyr package has easier ways to subset
# we will get to that later  




### Challenge ----

## part 1:
# make a data frame called weekly_rain
# and calculate total rainfall on that basis
# remember to use ?aggreswmp

weekly_rain <- aggreswmp(met_qc, by = "----", ---- = "totprcp", FUN = ----)

# what is the highest weekly rainfall amount, and when did it occur?
# just pull out the row of the data frame
weekly_rain[ -----, -----]




##### let's review a bit
##### functions we've covered so far:

### importing data
# read.csv()
# SWMPr::import_local()
# -- something we haven't gone over yet: 
# -- SWMPrExtension::import_local_nut() lets you choose between 
# -- grab and diel sample types



### examining data
# names(), head(), tail(), ncol(), nrow(), dim()
# str()
# class()
# plot()



### modifying data
# SWMPr::qaqc
# as.Date
# as.POSIXct
# lubridate::mdy_hm() and friends




### summarizing data
# mean(), min(), max(); na.rm = TRUE
# summary()
# SWMPr::aggreswmp()



### subsetting data
#  $ for columns
#  [rows, columns]





